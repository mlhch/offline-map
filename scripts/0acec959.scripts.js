"use strict";angular.module("yoAngular2App",["controllers","directives","services","ngCookies","ngResource","ngSanitize","ngRoute"]),angular.element(document).ready(function(){document.body.setAttribute("ng-controller","MainCtrl"),angular.bootstrap(document.body,["yoAngular2App"])}),angular.module("controllers",[]).controller("MainCtrl",["$scope","config",function(a,b){console.log("[controller.MainCtrl]",a.$id),b.get(function(b){a.tpCategories=b.tpCategories})}]),L.TileLayer.IndexedDB=L.TileLayer.extend({initialize:function(a,b){L.Util.setOptions(this,b),b.detectRetina&&L.Browser.retina&&b.maxZoom>0&&(b.tileSize=Math.floor(b.tileSize/2),b.zoomOffset++,b.minZoom>0&&b.minZoom--,this.options.maxZoom--),b.bounds&&(b.bounds=L.latLngBounds(b.bounds)),this._url=a;var c=this.options.subdomains;"string"==typeof c&&(this.options.subdomains=c.split(""))},getTileUrl:function(a,b){var c=this.options.store,d=["id",a.z,a.x,a.y].join("_"),e=L.Util.template(this._url,L.extend({s:this._getSubdomain(a),z:a.z,x:a.x,y:a.y},this.options));c.get(d,function(a){if(a)b.src=a.imgData,console.log("cached:",d);else{b.crossOrigin="*",b.src=e;var f=b.onload;b.onload=function(){var a=document.createElement("canvas");a.width=b.width,a.height=b.height,a.getContext("2d").drawImage(b,0,0),c.add({id:d,imgData:a.toDataURL()},function(){console.log("added:",d)}),f.call(b)}}})},_loadTile:function(a,b){a._layer=this,a.onload=this._tileOnLoad,a.onerror=this._tileOnError,this._adjustTilePoint(b),this.getTileUrl(b,a)}}),angular.module("directives",[]).directive("startDialog",[function(){return{restrict:"E",replace:!0,transclude:!0,templateUrl:"views/start-dialog.html",link:function(a,b){a.close=function(){b.modal("hide")},a.closeForever=function(){localStorage.startDialogDontShow="1",a.close()},localStorage.startDialogDontShow||(b.show(),b.modal({backdrop:!0,keyboard:!0}))}}}]).directive("map",["wfsLayer","indexedDB",function(a,b){return{restrict:"E",replace:!0,transclude:!0,template:'<div id="mapdiv"></div>',link:function(c,d){console.log("[directive.map] link",c.$id);var e=L.map(d[0],{center:[0,0],zoom:2,zoomControl:!1,maxZoom:18});b.getStore("tiles",function(a){e.addLayer(new L.TileLayer.IndexedDB("http://{s}.mqcdn.com/tiles/1.0.0/map/{z}/{x}/{y}.jpg",{store:a,internalName:"BG1",attribution:'<span>Â© OpenStreetMap contributors</span>&nbsp;|&nbsp;<span>Tiles Courtesy of <a href="http://www.mapquest.com/" target="_blank">MapQuest</a> <img src="http://developer.mapquest.com/content/osm/mq_logo.png"></span>',maxZoom:18,subdomains:["otile1","otile2","otile3","otile4"]}))},function(a){console.log(a)}),a.addTo(e),e.on("dragstart click mousedown focus zoomstart",function(a){c.$broadcast("mapFocused",a.type)}),c.$on("categoryStatusChanged",function(b,c,d){console.log("[on.categoryStatusChanged] - "+c.name+" "+d),d?a.showCategory(c,e.getBounds()):a.hideCategory(c)})}}}]).directive("layerSwitcher",function(){return{restrict:"E",replace:!0,transclude:!0,template:['<div class="tp-btn-map tp-icon tp-icon-category"'," ng-class=\"{true:'tp-icon-active',false:''}[layerPanelActive]\"",' ng-click="toggleLayerPanel()"></div>'].join(""),link:function(a){function b(){a.layerPanelActive=!0,d&&(clearTimeout(d),d=null),f.show(),setTimeout(function(){f.addClass("panel-visible")},1),$(window).trigger("resize")}function c(){a.layerPanelActive=!1,f.removeClass("panel-visible"),d=setTimeout(function(){f.hide()},400)}a.layerPanelActive=!1;var d,e={},f=$("#lswitch-panel");f.css("padding-top",($(window).height()-f.height())/2+"px !important"),a.toggleLayerPanel=function(){a.layerPanelActive?c():b()},a.isCategoryActive=function(a){return e[a]},a.toggleCategory=function(b){var c=b.name;e[c]=!e[c],a.$broadcast("categoryStatusChanged",b,e[c])},a.$on("mapFocused",function(b,d){a.$apply(function(){console.log("[on.mapFocused] - ",d,a.layerPanelActive),a.layerPanelActive&&c()})})}}}),angular.module("services",[]).factory("indexedDB",[function(){function a(a,b){var c=window.indexedDB.open(a,b);console.log("[services.indexedDB] openDatabase",a,b),c.onsuccess=function(b){g=b.target.result,console.log("[services.indexedDB] openDatabase.onsuccess",a,g.version),document.dispatchEvent(new CustomEvent(k.dbOpenSuccess,{detail:g}))},c.onerror=function(a){console.log("[services.indexedDB] openDatabase.onerror"),document.dispatchEvent(new CustomEvent(k.dbOpenFailure,{detail:a}))},c.onupgradeneeded=function(a){console.log("[services.indexedDB] openDatabase.onupgradeneeded");var b=a.target.result;i.forEach(function(a){b.objectStoreNames.contains(a)?console.log("store",a,"existing"):(console.log("creating store",a),b.createObjectStore(a,{keyPath:"id"}))})}}function b(a){var b=window.indexedDB.deleteDatabase(a);b.onsuccess=function(){console.log("[services.indexedDB] deleteDatabase.onsuccess -",a)},b.onerror=function(){console.log("[services.indexedDB] deleteDatabase.onerror",a)}}function c(b,f,i){function l(){document.removeEventListener(k.dbOpenSuccess,l),document.removeEventListener(k.dbOpenFailure,m),c(b,f,i)}function m(a){document.removeEventListener(k.dbOpenSuccess,l),document.removeEventListener(k.dbOpenFailure,m),i(a.detail)}return g?f({get:function(a,c){d(b,a,c)},add:function(a,c,d){e(b,a,c,d)}}):(document.addEventListener(k.dbOpenSuccess,l),document.addEventListener(k.dbOpenFailure,m),a(h,j),void 0)}function d(a,b,c){g.transaction(a).objectStore(a).get(b).onsuccess=function(){c(event.target.result)}}function e(a,b,c){g.transaction(a,"readwrite").objectStore(a).add(b).onsuccess=c}function f(a,b,d){c(a,function(a){a.get(b,function(a){"function"==typeof d&&d(a)})})}var g,h="travpad",i=["tiles","pois"],j=1,k={dbOpenSuccess:"dbOpenSuccess",dbOpenFailure:"dbOpenFailure",dbOpenUpgrade:"dbOpenUpgrade"};return{deleteDatabase:b,getStore:c,getRecord:f}}]).factory("config",["$resource",function(a){var b,c=new a("scripts/config.json");return{get:function(a){b?"function"==typeof a&&a(b):c.get(function(c){b=c,"function"==typeof a&&a(b)})},olStyleToLeaflet:function(a){a=a||{};var b={iconUrl:"images/"+a.externalGraphic,iconSize:a.graphicWidth&&a.graphicHeight?[a.graphicWidth,a.graphicHeight]:null,iconAnchor:[a.graphicXOffset?a.graphicWidth/2+a.graphicXOffset:0,-a.graphicYOffset],popupAnchor:[a.graphicXOffset||15,a.graphicYOffset]};return b}}}]).factory("wfs",["$resource","indexedDB",function(a,b){var c={service:"WFS",version:"1.1.0",request:"getfeature",typename:"travpad:pois",srsName:"EPSG:4326",format:"text/geojson",maxFeatures:500,outputFormat:"json"},d=new a("http://localhost:50001/proxy?url=http://localhost:8080/geoserver/wfs",null,{query:{method:"POST",isArray:!1}});return{query:function(a,e){var f=angular.extend({},c,{filter:a}),g=JSON.stringify(f);b.getStore("pois",function(a){a.get(g,function(b){return b?"function"==typeof e&&e(b.fc):void d.query(f,function(b){var c={};for(var d in b)"$"!==d[0]&&(c[d]=b[d]);a.add({id:g,fc:c},function(){console.log("paramsId:",g),"function"==typeof e&&e(c)})})})})}}}]).factory("wfsLayer",["wfs","config",function(a,b){function c(a,b){var c=a.map(function(a){return new OpenLayers.Filter.Logical({type:OpenLayers.Filter.Logical.AND,filters:a.split(";").map(function(a,b){return new OpenLayers.Filter.Comparison({type:OpenLayers.Filter.Comparison.EQUAL_TO,property:"category"+(b+1),value:a})})})}),d=new OpenLayers.Filter.Logical({type:OpenLayers.Filter.Logical.AND,filters:[new OpenLayers.Filter.Logical({type:OpenLayers.Filter.Logical.OR,filters:c}),new OpenLayers.Filter.Spatial({type:OpenLayers.Filter.Spatial.BBOX,value:b,projection:"EPSG:4326"})]});return(new OpenLayers.Format.XML).write(new OpenLayers.Format.Filter({version:"1.1.0"}).write(d))}var d,e={popupAnchor:[10,0]};return{addTo:function(a){d=new L.MarkerClusterGroup({spiderfyOnMaxZoom:!0,showCoverageOnHover:!0,zoomToBoundsOnClick:!0,removeOutsideVisibleBounds:!0,internalName:"wfsLayer"}),d.addTo(a)},showCategory:function(f,g){var h=OpenLayers.Bounds.fromString(g.toBBoxString());a.query(c([f.name],h),function(a){d.addLayer(L.geoJson(a,{pointToLayer:function(a,c){var d=a.properties.category2,g=$.extend({},e,b.olStyleToLeaflet(f.style));return d&&"RESTAURANT"===d.toUpperCase()&&(g.iconUrl="images/restaurant.png"),L.marker(c,{icon:L.icon(g)})},onEachFeature:function(a,b){var c=a.properties.shortnarrative||"";b.bindPopup(['<h2 style="margin-bottom: 5px;">',a.properties.name||"","</h2>",'<p style="margin: 0;">',c.length>100?c.substring(0,97)+" ...":c,"</p>"].join(""))}}))})},hideCategory:function(a){var b=[];d.eachLayer(function(c){c.feature.properties.category1===a.name&&b.push(c)}),d.removeLayers(b)}}}]);