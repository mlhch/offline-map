"use strict";angular.module("yoAngular2App",["ngCookies","ngResource","ngSanitize","ngRoute","directives","controllers","services"]),require({waitSeconds:0,map:{"*":{css:"require-css/css.min"}},paths:{moment:"momentjs/moment",angular:"angular/angular.min",leaflet:"leaflet-dist/leaflet-src",bootstrap:"bootstrap/dist/js/bootstrap.min"},shim:{angular:{exports:"angular"},leaflet:{exports:"L"}},baseUrl:"bower_components"}),angular.element(document).ready(function(){document.body.setAttribute("ng-controller","MainCtrl"),angular.bootstrap(document.body,["yoAngular2App"])}),angular.module("controllers",[]).controller("MainCtrl",["$scope","config",function(a,b){console.log("[controller.MainCtrl]"),b.get(function(b){a.tpCategories=b.tpCategories})}]),L.TileLayer.IndexedDB=L.TileLayer.extend({initialize:function(a,b){L.Util.setOptions(this,b),b.detectRetina&&L.Browser.retina&&b.maxZoom>0&&(b.tileSize=Math.floor(b.tileSize/2),b.zoomOffset++,b.minZoom>0&&b.minZoom--,this.options.maxZoom--),b.bounds&&(b.bounds=L.latLngBounds(b.bounds)),this._url=a;var c=this.options.subdomains;"string"==typeof c&&(this.options.subdomains=c.split(""))},getTileUrl:function(a,b){var c=this.options.indexedDB,d=["id",a.z,a.x,a.y].join("_"),e=L.Util.template(this._url,L.extend({s:this._getSubdomain(a),z:a.z,x:a.x,y:a.y},this.options));c.transaction("tiles","readwrite").objectStore("tiles").get(d).onsuccess=function(a){if(a.target.result)b.src=a.target.result.imgData,console.log("cached:",d);else{b.crossOrigin="*",b.src=e;var f=b.onload;b.onload=function(){var a=document.createElement("canvas");a.width=b.width,a.height=b.height,a.getContext("2d").drawImage(b,0,0),c.transaction("tiles","readwrite").objectStore("tiles").add({imgData:a.toDataURL()},d).onsuccess=function(){console.log("added:",d)},f.call(b)}}}},_loadTile:function(a,b){a._layer=this,a.onload=this._tileOnLoad,a.onerror=this._tileOnError,this._adjustTilePoint(b),this.getTileUrl(b,a)}}),angular.module("directives",[]).directive("startDialog",[function(){return{restrict:"E",replace:!0,transclude:!0,templateUrl:"views/start-dialog.html",link:function(a,b){a.close=function(){b.modal("hide")},a.closeForever=function(){localStorage.startDialogDontShow="1",a.close()},localStorage.startDialogDontShow||(b.show(),b.modal({backdrop:!0,keyboard:!0}))}}}]).directive("map",["wfsLayer",function(a){return{restrict:"E",replace:!0,transclude:!0,template:'<div id="mapdiv"></div>',link:function(b,c){console.log("[directive.map] link",b.$id);var d=L.map(c[0],{center:[0,0],zoom:2,zoomControl:!1,maxZoom:18}),e=window.indexedDB.open("maptiles",3);e.onsuccess=function(a){d.addLayer(new L.TileLayer.IndexedDB("http://{s}.mqcdn.com/tiles/1.0.0/map/{z}/{x}/{y}.jpg",{indexedDB:a.target.result,internalName:"BG1",attribution:'<span>Â© OpenStreetMap contributors</span>&nbsp;|&nbsp;<span>Tiles Courtesy of <a href="http://www.mapquest.com/" target="_blank">MapQuest</a> <img src="http://developer.mapquest.com/content/osm/mq_logo.png"></span>',maxZoom:18,subdomains:["otile1","otile2","otile3","otile4"]}))},e.onfailure=function(a){console.log(a)},e.onupgradeneeded=function(a){console.log("Upgrading..."),a.target.result.createObjectStore("tiles")},a.addTo(d),d.on("dragstart click mousedown focus zoomstart",function(a){b.$broadcast("mapFocused",a.type)}),b.$on("categoryStatusChanged",function(b,c,e){console.log("[on.categoryStatusChanged] - "+c.name+" "+e),e?a.showCategory(c,d.getBounds()):a.hideCategory(c)})}}}]).directive("layerSwitcher",function(){return{restrict:"E",replace:!0,transclude:!0,template:['<div class="tp-btn-map tp-icon tp-icon-category"'," ng-class=\"{true:'tp-icon-active',false:''}[layerPanelActive]\"",' ng-click="toggleLayerPanel()"></div>'].join(""),link:function(a){function b(){a.layerPanelActive=!0,d&&(clearTimeout(d),d=null),f.show(),setTimeout(function(){f.addClass("panel-visible")},1),$(window).trigger("resize")}function c(){a.layerPanelActive=!1,f.removeClass("panel-visible"),d=setTimeout(function(){f.hide()},400)}a.layerPanelActive=!1;var d,e={},f=$("#lswitch-panel");f.css("padding-top",($(window).height()-f.height())/2+"px !important"),a.toggleLayerPanel=function(){a.layerPanelActive?c():b()},a.isCategoryActive=function(a){return e[a]},a.toggleCategory=function(b){var c=b.name;e[c]=!e[c],a.$broadcast("categoryStatusChanged",b,e[c])},a.$on("mapFocused",function(b,d){a.$apply(function(){console.log("[on.mapFocused] - ",d,a.layerPanelActive),a.layerPanelActive&&c()})})}}}),angular.module("services",[]).factory("config",["$resource",function(a){var b,c=new a("scripts/config.json");return{get:function(a){b?"function"==typeof a&&a(b):c.get(function(c){b=c,"function"==typeof a&&a(b)})},olStyleToLeaflet:function(a){a=a||{};var b={iconUrl:"images/"+a.externalGraphic,iconSize:a.graphicWidth&&a.graphicHeight?[a.graphicWidth,a.graphicHeight]:null,iconAnchor:[a.graphicXOffset?a.graphicWidth/2+a.graphicXOffset:0,-a.graphicYOffset],popupAnchor:[a.graphicXOffset||15,a.graphicYOffset]};return b}}}]).factory("wfs",["$resource",function(a){var b={service:"WFS",version:"1.1.0",request:"getfeature",typename:"travpad:pois",srsName:"EPSG:4326",format:"text/geojson",maxFeatures:500,outputFormat:"json"},c=new a("http://localhost:50001/proxy?url=http://localhost:8080/geoserver/wfs",null,{query:{method:"POST",isArray:!1}});return{query:function(a,d){c.query(angular.extend({},b,{filter:a}),function(a){"function"==typeof d&&d(a)})}}}]).factory("wfsLayer",["wfs","config",function(a,b){function c(a,b){var c=a.map(function(a){return new OpenLayers.Filter.Logical({type:OpenLayers.Filter.Logical.AND,filters:a.split(";").map(function(a,b){return new OpenLayers.Filter.Comparison({type:OpenLayers.Filter.Comparison.EQUAL_TO,property:"category"+(b+1),value:a})})})}),d=new OpenLayers.Filter.Logical({type:OpenLayers.Filter.Logical.AND,filters:[new OpenLayers.Filter.Logical({type:OpenLayers.Filter.Logical.OR,filters:c}),new OpenLayers.Filter.Spatial({type:OpenLayers.Filter.Spatial.BBOX,value:b,projection:"EPSG:4326"})]});return(new OpenLayers.Format.XML).write(new OpenLayers.Format.Filter({version:"1.1.0"}).write(d))}var d,e={popupAnchor:[10,0]};return{addTo:function(a){d=new L.MarkerClusterGroup({spiderfyOnMaxZoom:!0,showCoverageOnHover:!0,zoomToBoundsOnClick:!0,removeOutsideVisibleBounds:!0,internalName:"wfsLayer"}),d.addTo(a)},showCategory:function(f,g){var h=OpenLayers.Bounds.fromString(g.toBBoxString());a.query(c([f.name],h),function(a){d.addLayer(L.geoJson(a,{pointToLayer:function(a,c){var d=a.properties.category2,g=$.extend({},e,b.olStyleToLeaflet(f.style));return d&&"RESTAURANT"===d.toUpperCase()&&(g.iconUrl="images/restaurant.png"),L.marker(c,{icon:L.icon(g)})},onEachFeature:function(a,b){var c=a.properties.shortnarrative||"";b.bindPopup(['<h2 style="margin-bottom: 5px;">',a.properties.name||"","</h2>",'<p style="margin: 0;">',c.length>100?c.substring(0,97)+" ...":c,"</p>"].join(""))}}))})},hideCategory:function(a){var b=[];d.eachLayer(function(c){c.feature.properties.category1===a.name&&b.push(c)}),d.removeLayers(b)}}}]);