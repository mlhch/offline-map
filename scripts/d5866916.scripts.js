"use strict";angular.module("yoAngular2App",["controllers","directives","services","ngCookies","ngResource","ngSanitize","ngRoute"]),angular.element(document).ready(function(){document.body.setAttribute("ng-controller","MainCtrl"),angular.bootstrap(document.body,["yoAngular2App"])}),angular.module("controllers",[]).controller("MainCtrl",["$scope","config",function(a,b){console.log("[controller.MainCtrl]",a.$id),b.get(function(b){a.tpCategories=b.tpCategories})}]),L.TileLayer.IndexedDB=L.TileLayer.extend({initialize:function(a,b){L.Util.setOptions(this,b),b.detectRetina&&L.Browser.retina&&b.maxZoom>0&&(b.tileSize=Math.floor(b.tileSize/2),b.zoomOffset++,b.minZoom>0&&b.minZoom--,this.options.maxZoom--),b.bounds&&(b.bounds=L.latLngBounds(b.bounds)),this._url=a;var c=this.options.subdomains;"string"==typeof c&&(this.options.subdomains=c.split(""))},getTileUrl:function(a,b){var c=this.options.store,d=["id",a.z,a.x,a.y].join("_"),e=L.Util.template(this._url,L.extend({s:this._getSubdomain(a),z:a.z,x:a.x,y:a.y},this.options));c.get(d,function(a){if(a)b.src=a.imgData,console.log("cached:",d);else{b.crossOrigin="*",b.src=e;var f=b.onload;b.onload=function(){var a=document.createElement("canvas");a.width=b.width,a.height=b.height,a.getContext("2d").drawImage(b,0,0),c.add({id:d,imgData:a.toDataURL()},function(){console.log("added:",d)}),f.call(b)}}})},_loadTile:function(a,b){a._layer=this,a.onload=this._tileOnLoad,a.onerror=this._tileOnError,this._adjustTilePoint(b),this.getTileUrl(b,a)}}),angular.module("directives",[]).directive("startDialog",[function(){return{restrict:"E",replace:!0,transclude:!0,templateUrl:"views/start-dialog.html",link:function(a,b){a.close=function(){b.modal("hide")},a.closeForever=function(){localStorage.startDialogDontShow="1",a.close()},localStorage.startDialogDontShow||(b.show(),b.modal({backdrop:!0,keyboard:!0}))}}}]).directive("map",["wfsLayer","indexedDB",function(a,b){return{restrict:"E",replace:!0,transclude:!0,template:'<div id="mapdiv"></div>',link:function(c,d){console.log("[directive.map] link",c.$id);var e=L.map(d[0],{center:[0,0],zoom:2,zoomControl:!1,maxZoom:18});b.getStore("tiles",function(a){e.addLayer(new L.TileLayer.IndexedDB("http://{s}.mqcdn.com/tiles/1.0.0/map/{z}/{x}/{y}.jpg",{store:a,internalName:"BG1",attribution:'<span>Â© OpenStreetMap contributors</span>&nbsp;|&nbsp;<span>Tiles Courtesy of <a href="http://www.mapquest.com/" target="_blank">MapQuest</a> <img src="http://developer.mapquest.com/content/osm/mq_logo.png"></span>',maxZoom:18,subdomains:["otile1","otile2","otile3","otile4"]}))},function(a){console.log(a)}),a.addTo(e),e.on("dragstart click mousedown focus zoomstart",function(a){c.$broadcast("mapFocused",a.type)}),e.on("moveend",function(){a.refresh(e.getBounds())}),c.$on("categoryStatusChanged",function(b,c,d){console.log("[on.categoryStatusChanged] - "+c.name+" "+d),d?a.showCategory(c,e.getBounds()):a.hideCategory(c)})}}}]).directive("layerSwitcher",function(){return{restrict:"E",replace:!0,transclude:!0,template:['<div class="tp-btn-map tp-icon tp-icon-category"'," ng-class=\"{true:'tp-icon-active',false:''}[layerPanelActive]\"",' ng-click="toggleLayerPanel()"></div>'].join(""),link:function(a){function b(){a.layerPanelActive=!0,d&&(clearTimeout(d),d=null),f.show(),setTimeout(function(){f.addClass("panel-visible")},1),$(window).trigger("resize")}function c(){a.layerPanelActive=!1,f.removeClass("panel-visible"),d=setTimeout(function(){f.hide()},400)}a.layerPanelActive=!1;var d,e={},f=$("#lswitch-panel");f.css("padding-top",($(window).height()-f.height())/2+"px !important"),a.toggleLayerPanel=function(){a.layerPanelActive?c():b()},a.isCategoryActive=function(a){return e[a]},a.toggleCategory=function(b){var c=b.name;e[c]=!e[c],a.$broadcast("categoryStatusChanged",b,e[c])},a.$on("mapFocused",function(b,d){a.$apply(function(){console.log("[on.mapFocused] - ",d,a.layerPanelActive),a.layerPanelActive&&c()})})}}}),angular.module("services",[]).factory("indexedDB",[function(){function a(a,b){var c=window.indexedDB.open(a,b);console.log("[services.indexedDB] openDatabase",a,b),c.onsuccess=function(b){j=b.target.result,console.log("[services.indexedDB] openDatabase.onsuccess",a,j.version),document.dispatchEvent(new CustomEvent(n.dbOpenSuccess,{detail:j}))},c.onerror=function(a){console.log("[services.indexedDB] openDatabase.onerror"),document.dispatchEvent(new CustomEvent(n.dbOpenFailure,{detail:a}))},c.onupgradeneeded=function(a){console.log("[services.indexedDB] openDatabase.onupgradeneeded");var b=a.target.result;l.forEach(function(a){b.objectStoreNames.contains(a)?console.log("store",a,"existing"):(console.log("creating store",a),b.createObjectStore(a,{keyPath:"id"}))})}}function b(a){var b=window.indexedDB.deleteDatabase(a);b.onsuccess=function(){console.log("[services.indexedDB] deleteDatabase.onsuccess -",a)},b.onerror=function(){console.log("[services.indexedDB] deleteDatabase.onerror",a)}}function c(b,e,f){function g(){document.removeEventListener(n.dbOpenSuccess,g),document.removeEventListener(n.dbOpenFailure,h),c(b,e,f)}function h(a){document.removeEventListener(n.dbOpenSuccess,g),document.removeEventListener(n.dbOpenFailure,h),f(a.detail)}return j?e(d(b)):(document.addEventListener(n.dbOpenSuccess,g),document.addEventListener(n.dbOpenFailure,h),a(k,m),void 0)}function d(a){return{get:function(b,c){e(a,b,c)},add:function(b,c){if(Array.isArray(b)){var d=-1,e=[];!function g(){++d<b.length?f(a,b[d],function(){e.push(b[d])&&g()},g):c(e)}()}else f(a,b,c)},find:function(b,c){h(a,b,c)},update:function(b,c){g(a,b,c)}}}function e(a,b,c){j.transaction(a).objectStore(a).get(b).onsuccess=function(){c(event.target.result)}}function f(a,b,c,d){var e=j.transaction(a,"readwrite").objectStore(a).add(b);e.onsuccess=c,e.onerror=d}function g(a,b,c,d){var e=j.transaction(a,"readwrite").objectStore(a).put(b);e.onsuccess=c,e.onerror=d}function h(a,b,c){var d=[];j.transaction(a,"readwrite").objectStore(a).openCursor().onsuccess=function(a){var e=a.target.result;e?(("function"!=typeof c||!0===c(e.value,e))&&d.push(e.value),e["continue"]()):b(d)}}function i(a,b,d){c(a,function(a){a.get(b,function(a){"function"==typeof d&&d(a)})})}var j,k="travpad",l=["tiles","pois"],m=1,n={dbOpenSuccess:"dbOpenSuccess",dbOpenFailure:"dbOpenFailure",dbOpenUpgrade:"dbOpenUpgrade"};return{deleteDatabase:b,getStore:c,getRecord:i}}]).factory("config",["$resource",function(a){var b,c=new a("scripts/config.json");return{get:function(a){b?"function"==typeof a&&a(b):c.get(function(c){b=c,"function"==typeof a&&a(b)})},olStyleToLeaflet:function(a){a=a||{};var b={iconUrl:"images/"+a.externalGraphic,iconSize:a.graphicWidth&&a.graphicHeight?[a.graphicWidth,a.graphicHeight]:null,iconAnchor:[a.graphicXOffset?a.graphicWidth/2+a.graphicXOffset:0,-a.graphicYOffset],popupAnchor:[a.graphicXOffset||15,a.graphicYOffset]};return b}}}]).factory("wfs",["$resource","indexedDB",function(a,b){function c(a,b,c){var d,e=-1;!function f(){if(d=a[++e]){if(!0===i[d.name])return f();h.get({categoryName:d.name.replace(/\W+/g,"-")},function(a){i[d.name]===a.features.length?i[d.name]=!0:(i[d.name]=a.features.length,b(a),f())},c)}}()}function d(a,b){var c=a.map(function(a){return new OpenLayers.Filter.Logical({type:OpenLayers.Filter.Logical.AND,filters:a.name.split(";").map(function(a,b){return new OpenLayers.Filter.Comparison({type:OpenLayers.Filter.Comparison.EQUAL_TO,property:"category"+(b+1),value:a})})})}),d=new OpenLayers.Filter.Logical({type:OpenLayers.Filter.Logical.AND,filters:[new OpenLayers.Filter.Logical({type:OpenLayers.Filter.Logical.OR,filters:c}),new OpenLayers.Filter.Spatial({type:OpenLayers.Filter.Spatial.BBOX,value:b,projection:"EPSG:4326"})]});return(new OpenLayers.Format.XML).write(new OpenLayers.Format.Filter({version:"1.1.0"}).write(d))}function e(a,e,h){var i=angular.extend({},f,{filter:d(a,e)});b.getStore("pois",function(b){function d(a){console.log("[service.wfs] query.local.wfs",a.features.length),b.add(a.features,function(b){console.log("[service.wfs] query.store.added",b.length,"/",a.features.length),"function"==typeof h&&h(b)})}function f(){g.query(i,function(a){console.log("[service.wfs] query.geoserver.wfs",a.features.length),b.add(a.features,function(b){console.log("[service.wfs] query.store.added",b.length,"/",a.features.length),"function"==typeof h&&h(b)})},function(){console.log("[service.wfs] query.geoserver.wfs","Bad Gateway")})}b.find(function(b){console.log("[service.wfs] query.store.find",b.length),b.length&&"function"==typeof h&&h(b),c(a,d,f)},function(b){var c=b.geometry.coordinates,d=c[1],f=c[0];return e.contains(f,d)?b.properties&&a.some(function(a){return a.name===b.properties.category1}):!1})})}var f={service:"WFS",version:"1.1.0",request:"getfeature",typename:"travpad:pois",srsName:"EPSG:4326",format:"text/geojson",maxFeatures:500,outputFormat:"json"},g=new a("http://localhost:50001/proxy?url=http://localhost:8080/geoserver/wfs",null,{query:{method:"POST",isArray:!1}}),h=new a("apis/pois.:categoryName.json"),i={};return{query:e}}]).factory("wfsLayer",["wfs","config",function(a,b){function c(c,f){var g={},h=OpenLayers.Bounds.fromString(f.toBBoxString());c.forEach(function(a){g[a.name]=a.style}),a.query(c,h,function(a){d.addLayer(L.geoJson(a,{pointToLayer:function(a,c){var d=a.properties.category2,f=$.extend({},e,b.olStyleToLeaflet(g[a.properties.category1]));return d&&"RESTAURANT"===d.toUpperCase()&&(f.iconUrl="images/restaurant.png"),L.marker(c,{icon:L.icon(f)})},onEachFeature:function(a,b){var c=a.properties.shortnarrative||"";b.bindPopup(['<h2 style="margin-bottom: 5px;">',a.properties.name||"","</h2>",'<p style="margin: 0;">',c.length>100?c.substring(0,97)+" ...":c,"</p>"].join(""))}}))})}var d,e={popupAnchor:[10,0]},f=[];return{addTo:function(a){d=new L.MarkerClusterGroup({spiderfyOnMaxZoom:!0,showCoverageOnHover:!0,zoomToBoundsOnClick:!0,removeOutsideVisibleBounds:!0,internalName:"wfsLayer"}),d.addTo(a)},showCategory:function(a,b){f.push(a),c([a],b)},refresh:function(a){d.clearLayers(),c(f,a)},hideCategory:function(a){f.splice(f.indexOf(a),1);var b=[];d.eachLayer(function(c){c.feature.properties.category1===a.name&&b.push(c)}),d.removeLayers(b)}}}]);